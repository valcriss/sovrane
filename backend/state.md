# Project State Overview

This document provides an overview of the backend codebase and describes the purpose of each source file. The project follows a **hexagonal architecture** as described in `AGENTS.md` and is entirely written in TypeScript.

## Directory Structure

```
backend/
├── adapters/                 # Technical implementations of domain ports
│   ├── audit/                # Audit log adapter
│   ├── auth/                 # Authentication services
│   ├── controllers/          # REST and WebSocket controllers
│   ├── email/                # Email services
│   ├── logger/               # Logging implementation
│   ├── orm/                  # Prisma schema and migrations
│   ├── repositories/         # Database repositories
│   ├── storage/              # File storage backends
│   └── token/                # JWT token service
├── bruno/                    # HTTP request collection used for API testing
├── domain/                   # Pure domain entities, ports and services
├── docs/                     # Project documentation
├── infrastructure/           # Application bootstrap and helpers
├── scripts/                  # Utility scripts
├── tests/                    # Jest test suite
├── usecases/                 # Application use cases
├── docker-compose.dev.yml    # Development services
├── jest.config.js            # Jest configuration
├── openapi.json              # Generated OpenAPI specification
├── package.json              # NPM scripts and dependencies
├── tsconfig.json             # TypeScript configuration
└── index.ts                  # (empty entry point placeholder)
```

The sections below describe each file grouped by directory.

## adapters

### audit
- **PrismaAudit.ts** – Logs `AuditEvent` instances to the Prisma `AuditLog` table. Contains `log(event)` method.

### auth
- **CompositeAuthService.ts** – Aggregates multiple `AuthServicePort` implementations. Methods: `authenticate`, `authenticateWithProvider`, `requestPasswordReset`, `resetPassword`, `verifyToken`.
- **JWTAuthServiceAdapter.ts** – Authenticates users with credentials stored in PostgreSQL and verifies JWT tokens. Implements all methods from `AuthServicePort`.
- **OIDCAuthServiceAdapter.ts** – Verifies tokens from an external OIDC provider. Implements the same methods as above (password related functions throw).

### controllers
- **rest/requestValidator.ts** – Middleware helper to validate request bodies.
- **rest/userController.ts** – Express router exposing user CRUD and authentication endpoints.
- **rest/departmentController.ts** – REST routes for departments.
- **rest/groupController.ts** – REST routes for user groups.
- **rest/siteController.ts** – REST routes for sites.
- **rest/roleController.ts** – REST routes for roles.
- **rest/permissionController.ts** – REST routes for permissions.
- **rest/invitationController.ts** – REST routes for user invitations.
- **websocket/userGateway.ts** – Socket.IO gateway authenticating connections and responding to basic events.

### email
- **ConsoleEmailServiceAdapter.ts** – Simple email service logging messages to the console. Method: `sendMail`.
- **NodemailerEmailServiceAdapter.ts** – Sends real emails using Nodemailer with optional templates. Method: `sendMail`.

### logger
- **ConsoleLoggerAdapter.ts** – Logging adapter writing to STDOUT. Methods: `error`, `warn`, `info`, `debug`, `trace`.

### orm
- **prisma/schema.prisma** – Prisma data model describing all persistence tables.
- **prisma/migrations/** – Database migration files generated by Prisma.

### repositories
Database repositories implementing CRUD operations for each entity:
- **PrismaUserRepository.ts** – Implements `UserRepositoryPort`.
- **PrismaRoleRepository.ts** – Implements `RoleRepositoryPort`.
- **PrismaPermissionRepository.ts** – Implements `PermissionRepositoryPort`.
- **PrismaDepartmentRepository.ts** – Implements `DepartmentRepositoryPort`.
- **PrismaSiteRepository.ts** – Implements `SiteRepositoryPort`.
- **PrismaUserGroupRepository.ts** – Implements `UserGroupRepositoryPort`.
- **PrismaInvitationRepository.ts** – Implements `InvitationRepositoryPort`.
- **PrismaRefreshTokenRepository.ts** – Implements `RefreshTokenRepositoryPort`.

### storage
- **LocalFileStorageAdapter.ts** – Stores files on the local filesystem. Methods: `upload`, `download`, `delete`, `getPublicUrl`.
- **S3FileStorageAdapter.ts** – Stores files in Amazon S3. Methods mirror those of the local adapter.

### token
- **JWTTokenServiceAdapter.ts** – Generates and verifies JWT access/refresh tokens. Methods: `generateAccessToken`, `generateRefreshToken`.

## bruno
Collection of `.bru` files used with the Bruno API client. They demonstrate how to call each REST endpoint. `bruno.json` defines the workspace.

## domain

### entities
Data classes representing core concepts:
- **User.ts**, **Role.ts**, **Permission.ts**, **PermissionKeys.ts**, **Department.ts**, **Site.ts**, **UserGroup.ts**, **Invitation.ts**, **RefreshToken.ts**, **AuditEvent.ts**.
Each file exports a class with properties and a constructor documenting every field.

### ports
Interfaces defining contracts between the domain and infrastructure:
`AuthServicePort`, `TokenServicePort`, `UserRepositoryPort`, `RoleRepositoryPort`, `PermissionRepositoryPort`, `DepartmentRepositoryPort`, `SiteRepositoryPort`, `UserGroupRepositoryPort`, `InvitationRepositoryPort`, `RefreshTokenRepositoryPort`, `AuditPort`, `FileStoragePort`, `AvatarServicePort`, `EmailServicePort`, `LoggerPort`.

### services
- **AvatarService.ts** – Handles avatar upload/deletion using a storage adapter and user repository.
- **PermissionChecker.ts** – Utility to verify whether a `User` has a given permission.

### dtos
- **PaginatedResult.ts** – Shared interfaces for pagination results and query parameters.

## infrastructure
- **server.ts** – Application bootstrap creating Express app, registering routers, starting Socket.IO server and wiring adapters with the Prisma client.
- **createPrisma.ts** – Helper instantiating Prisma client and forwarding SQL queries to the logger.
- **loggerContext.ts** – Async-local storage utilities for propagating logging context.
- **swagger.ts** – Configures Swagger UI using annotations from REST controllers.

## usecases
Application services encapsulating domain logic. Each file exposes a single class with an `execute` method implementing one specific action. Categories include:
- **user/** – authentication, profile update, listing etc.
- **department/** – managing departments and their relationships.
- **group/** – user group management.
- **invitation/** – invite workflow.
- **role/** – CRUD for roles.
- **permission/** – CRUD for permissions.
- **site/** – site CRUD.

## scripts
- **init-application.js** – Initializes the database with an administrator account.
- **syncPermissions.ts** – Synchronizes permission keys defined in the code with the database.

## docs
- **Logging.md** – Guidelines for using the logging service and examples.

## tests
Comprehensive Jest test suite covering entities, ports, adapters, use cases and infrastructure helpers. Each `*.test.ts` file mirrors a corresponding source file ensuring 100% coverage as configured in `jest.config.js`.

## other root files
- **docker-compose.dev.yml** – Local development services (PostgreSQL).
- **jest.config.js** – Jest configuration enforcing full coverage.
- **openapi.json** – Generated OpenAPI specification from controller annotations.
- **package.json** / **package-lock.json** – Project dependencies and scripts.
- **tsconfig.json** – TypeScript compiler options.
- **index.ts** – Placeholder main entry (currently empty).

---

This summary reflects the current state of the backend and can be shared with ChatGPT to facilitate further development.
