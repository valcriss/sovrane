# Project State Overview

This document provides an overview of the backend codebase and describes the purpose of each source file. The project follows a **hexagonal architecture** as described in `AGENTS.md` and is entirely written in TypeScript.

## Directory Structure

```
backend/
├── adapters/                 # Technical implementations of domain ports
│   ├── audit/                # Audit log adapter
│   ├── auth/                 # Authentication services
│   ├── cache/                # Cache backends
│   ├── config/               # Configuration persistence
│   ├── controllers/          # REST and WebSocket controllers
│   ├── email/                # Email services
│   ├── logger/               # Logging implementation
│   ├── mfa/                  # Multi-factor authentication providers
│   ├── notification/         # Notification senders
│   ├── orm/                  # Prisma schema and migrations
│   ├── realtime/             # Real-time communication
│   ├── repositories/         # Database repositories
│   ├── scheduler/            # Cron job runner
│   ├── storage/              # File storage backends
│   └── token/                # JWT token service
├── domain/                   # Pure domain entities, ports and services
├── docs/                     # Project documentation (including `docs/bruno`)
├── infrastructure/           # Application bootstrap and helpers
├── scripts/                  # Utility scripts
├── templates/                # Mustache templates used by email adapters
├── tests/                    # Jest test suite
├── usecases/                 # Application use cases
├── docker-compose.dev.yml    # Development services
├── jest.config.js            # Jest configuration
├── openapi.json              # Generated OpenAPI specification
├── package.json              # NPM scripts and dependencies
└── tsconfig.json             # TypeScript configuration
```

The sections below describe each file grouped by directory.

## adapters

### audit
- **PrismaAudit.ts** – Logs `AuditEvent` instances to the Prisma `AuditLog` table. Contains `log(event)` method.
- **PrismaAuditConfigAdapter.ts** – Persists audit configuration settings.

### auth
- **CompositeAuthService.ts** – Aggregates multiple `AuthServicePort` implementations. Methods: `authenticate`, `authenticateWithProvider`, `requestPasswordReset`, `resetPassword`, `verifyToken`.
- **JWTAuthServiceAdapter.ts** – Authenticates users with credentials stored in PostgreSQL and verifies JWT tokens. Implements all methods from `AuthServicePort`.
- **OIDCAuthServiceAdapter.ts** – Verifies tokens from an external OIDC provider. Implements the same methods as above (password related functions throw).

### cache
- **InMemoryCacheAdapter.ts** – Simple map-based cache used mainly for tests.
- **RedisCacheAdapter.ts** – Redis implementation of `CachePort`.

### config
- **PrismaConfigAdapter.ts** – Stores application configuration values in the database.

### controllers
- **rest/requestValidator.ts** – Middleware helper to validate request bodies.
- **rest/userController.ts** – Express router exposing user CRUD and authentication endpoints.
- **rest/departmentController.ts** – REST routes for departments.
- **rest/groupController.ts** – REST routes for user groups.
- **rest/siteController.ts** – REST routes for sites.
- **rest/roleController.ts** – REST routes for roles.
- **rest/permissionController.ts** – REST routes for permissions.
- **rest/invitationController.ts** – REST routes for user invitations.
- **rest/configController.ts** – Manage application configuration entries.
- **rest/auditController.ts** – Audit log endpoints.
- **websocket/userGateway.ts** – Socket.IO gateway authenticating connections and responding to basic events.
- **websocket/departmentGateway.ts**, **websocket/groupGateway.ts**, **websocket/roleGateway.ts**, **websocket/permissionGateway.ts**, **websocket/siteGateway.ts**, **websocket/configGateway.ts**, **websocket/invitationGateway.ts**, **websocket/auditGateway.ts** – Real-time updates for each entity type.

### email
- **ConsoleEmailServiceAdapter.ts** – Simple email service logging messages to the console. Method: `sendMail`.
- **NodemailerEmailServiceAdapter.ts** – Sends real emails using Nodemailer with optional templates. Method: `sendMail`.

### notification
- **EmailNotificationAdapter.ts** – Sends notification emails via the configured mail service.

### logger
- **ConsoleLoggerAdapter.ts** – Logging adapter writing to STDOUT. Methods: `error`, `warn`, `info`, `debug`, `trace`.

### orm
- **prisma/schema.prisma** – Prisma data model describing all persistence tables.
- **prisma/migrations/** – Database migration files generated by Prisma.

### repositories
Database repositories implementing CRUD operations for each entity:
- **PrismaUserRepository.ts** – Implements `UserRepositoryPort`.
- **PrismaRoleRepository.ts** – Implements `RoleRepositoryPort`.
- **PrismaPermissionRepository.ts** – Implements `PermissionRepositoryPort`.
- **PrismaDepartmentRepository.ts** – Implements `DepartmentRepositoryPort`.
- **PrismaSiteRepository.ts** – Implements `SiteRepositoryPort`.
- **PrismaUserGroupRepository.ts** – Implements `UserGroupRepositoryPort`.
- **PrismaInvitationRepository.ts** – Implements `InvitationRepositoryPort`.
- **PrismaRefreshTokenRepository.ts** – Implements `RefreshTokenPort`.

### storage
- **LocalFileStorageAdapter.ts** – Stores files on the local filesystem. Methods: `upload`, `download`, `delete`, `getPublicUrl`.
- **S3FileStorageAdapter.ts** – Stores files in Amazon S3. Methods mirror those of the local adapter.

### token
- **JWTTokenServiceAdapter.ts** – Generates and verifies JWT access/refresh tokens. Methods: `generateAccessToken`, `generateRefreshToken`.
### scheduler

- **NodeCronScheduler.ts** – Registers cron jobs using node-cron.
- **jobs.ts** – Factory creating scheduled jobs including security alert detection.

### realtime
- **SocketIORealtimeAdapter.ts** – Emits events to connected Socket.IO clients.

### mfa
- **EmailOTPAdapter.ts** – Sends one-time passwords via email.
- **TOTPAdapter.ts** – Generates and verifies time-based codes using a shared secret.


## bruno
The `docs/bruno` folder contains a collection of `.bru` files used with the Bruno API client. They demonstrate how to call each REST endpoint. `bruno.json` defines the workspace.

## domain

### entities
Data classes representing core concepts:
- **User.ts**, **Role.ts**, **Permission.ts**, **PermissionKeys.ts**, **Department.ts**, **Site.ts**, **UserGroup.ts**, **Invitation.ts**, **RefreshToken.ts**, **AuditEvent.ts**, **AuditEventType.ts**, **SecurityAlert.ts**, **AppConfig.ts**, **AppConfigKeys.ts**, **AuditConfig.ts**, **UserPermissionAssignment.ts**, **RolePermissionAssignment.ts**
Each file exports a class with properties and a constructor documenting every field.

### ports
Interfaces defining contracts between the domain and infrastructure:
`AuthServicePort`, `TokenServicePort`, `UserRepositoryPort`, `RoleRepositoryPort`, `PermissionRepositoryPort`, `DepartmentRepositoryPort`, `SiteRepositoryPort`, `UserGroupRepositoryPort`, `InvitationRepositoryPort`, `RefreshTokenPort`, `AuditPort`, `AuditConfigPort`, `FileStoragePort`, `AvatarServicePort`, `EmailServicePort`, `LoggerPort`, `NotificationPort`, `SchedulerPort`, `CachePort`, `ConfigPort`, `MfaServicePort`, `OtpStorePort`, `RealtimePort`.

### services
- **AvatarService.ts** – Handles avatar upload/deletion using a storage adapter and user repository.
- **PermissionChecker.ts** – Utility to verify whether a `User` has a given permission.
- **AuditConfigService.ts** – Retrieves and updates audit logging settings with caching.
- **CacheService.ts** – Helper to lazily load values using a cache adapter.
- **ConfigService.ts** – Accessor for application configuration values with caching.
- **PasswordValidator.ts** – Validates password complexity rules.
- **BootstapService.ts** – Initialises mandatory configuration and default permissions.

### dtos
- **PaginatedResult.ts** – Shared interfaces for pagination results and query parameters.
- **AuditLogQuery.ts** – Parameters for retrieving pages of audit log entries.

## infrastructure
- **server.ts** – Application bootstrap creating Express app, registering routers, starting Socket.IO server and wiring adapters with the Prisma client.
- **createPrisma.ts** – Helper instantiating Prisma client and forwarding SQL queries to the logger.
- **loggerContext.ts** – Async-local storage utilities for propagating logging context.
- **swagger.ts** – Configures Swagger UI using annotations from REST controllers.

## usecases
Application services encapsulating domain logic. Each file exposes a single class with an `execute` method implementing one specific action. Categories include:
- **user/** – authentication, profile update, listing etc.
- **department/** – managing departments and their relationships.
- **group/** – user group management.
- **invitation/** – invite workflow.
- **role/** – CRUD for roles.
- **permission/** – CRUD for permissions.
- **site/** – site CRUD.
- **config/** – reading and updating configuration values.
- **audit/** – retrieving and updating audit settings.
- **cron/** – tasks executed periodically by the scheduler.
- **SecurityAlertDetectorUseCase.ts** – detects suspicious logins and returns alerts.
- **SendPasswordExpiryWarningsUseCase.ts** – emails users when passwords near expiry.

## scripts
The folder currently only contains **init-application.js**, which seeds the database with an administrator account.

## docs
- **Logging.md** – Guidelines for using the logging service and examples.
- **Audit.md** – Details on audit log configuration and usage.
- **Alerting.md** – Explains security alert detection and notification.
- **MFA.md** – How to configure multi-factor authentication.
- **Websocket.md** – Description of the real-time gateway API.

## tests
Comprehensive Jest test suite covering entities, ports, adapters, use cases and infrastructure helpers. Each `*.test.ts` file mirrors a corresponding source file ensuring 100% coverage as configured in `jest.config.js`.

## other root files
- **docker-compose.dev.yml** – Local development services (PostgreSQL).
- **jest.config.js** – Jest configuration enforcing full coverage.
- **openapi.json** – Generated OpenAPI specification from controller annotations.
- **package.json** / **package-lock.json** – Project dependencies and scripts.
- **tsconfig.json** – TypeScript compiler options.


---

This summary reflects the current state of the backend and can be shared with ChatGPT to facilitate further development.
